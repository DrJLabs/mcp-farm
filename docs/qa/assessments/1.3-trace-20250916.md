# Requirements Traceability Matrix — Story 1.3: PRM and 401 Hint

Date: 2025-09-16
Story File: docs/stories/1.3.prm-and-401-hint.md
Implementation Evidence: docs/qa/evidence/1.3-*.{txt,json}

## Coverage Summary
- Total Requirements: 5
- Fully Covered: 5 (100%)
- Partially Covered: 0 (0%)
- Not Covered: 0 (0%)

## Requirement Mappings

### AC1 — PRM endpoint returns canonical JSON over HTTPS
Coverage: Full

- Test Mapping
  - test_file: tests/test_prm_and_401.py
    test_case: test_prm_route_returns_expected_payload
    given: FastMCP server with issuer/audience env configured and auth enabled
    when: GET `/.well-known/oauth-protected-resource`
    then: Response is HTTP 200 with Cache-Control 60s and JSON payload matching MCP_SERVER_URL and Keycloak issuer
  - Evidence: docs/qa/evidence/1.3-prm-status.txt, 1.3-prm-body.json (curl output via TestClient proxy)

### AC2 — PRM reachable publicly via routing stack
Coverage: Full

- Test Mapping
  - test_file: tests/test_prm_and_401.py
    test_case: test_prm_route_returns_expected_payload
    given: Streamable HTTP path `/mcp` mounted with RemoteAuthProvider
    when: Public client hits PRM route without auth
    then: Metadata accessible unauthenticated with TLS-ready headers
  - Evidence: Same as AC1 plus 1.3-prm-headers.txt verifying content-type and cache policy

### AC3 — Unauthenticated protected endpoints return 401 with PRM hint
Coverage: Full

- Test Mapping
  - test_file: tests/test_prm_and_401.py
    test_case: test_unauthenticated_mcp_returns_401_with_prm_hint
    given: Auth-enabled server and no bearer token supplied
    when: GET `/mcp`
    then: HTTP 401 with `WWW-Authenticate: Bearer resource_metadata="https://mcp.localhost/.well-known/oauth-protected-resource"`
  - Evidence: docs/qa/evidence/1.3-401-status.txt, 1.3-401-headers.txt

### AC4 — Public routes stay unauthenticated; auth toggles via env
Coverage: Full

- Test Mapping
  - test_file: tests/test_prm_and_401.py
    test_case: test_health_is_public_when_auth_enabled
    given: Auth-enabled server
    when: GET `/healthz`
    then: HTTP 200 JSON `{ "ok": true }`
  - test_file: tests/test_prm_and_401.py
    test_case: test_server_without_issuer_keeps_auth_disabled
    given: Issuer env variables unset
    when: Instantiate server
    then: `server.auth is None` and no auth middleware applied

### AC5 — Validation evidence captured for Gate A
Coverage: Full

- Evidence Mapping (manual)
  - Evidence: docs/qa/evidence/1.3-prm-*.json/txt and 1.3-401-*.txt plus 1.3-health-*.json/txt collected via scripted curl/TestClient
    given: Story DoD checklist completion
    when: Evidence artifacts stored alongside QA docs
    then: Gate A reviewers have traceable outputs for PRM JSON, 401 headers, and health check

## Coverage Gaps
- None identified.

## Recommendations
- Maintain curl evidence scripts in CI for future regressions.
- Add live JWKS availability smoke in subsequent stories (S4) once Keycloak integration lands.

## Gate Snippet
```yaml
trace:
  totals:
    requirements: 5
    full: 5
    partial: 0
    none: 0
  planning_ref: 'docs/qa/assessments/1.3-test-design-20250916.md'
  uncovered: []
  notes: 'See docs/qa/assessments/1.3-trace-20250916.md'
```

Trace matrix: docs/qa/assessments/1.3-trace-20250916.md
