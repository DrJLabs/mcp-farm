# QA Risk Profile — Story 1.3: PRM and 401 Hint

Date: 2025-09-16
Story: docs/stories/1.3.prm-and-401-hint.md
Scope: Publish PRM JSON and enforce PRM-linked 401 challenges when OAuth issuer envs are configured.

## Summary
Overall Risk: Medium (Security)
Primary Modes: Configuration drift affecting PRM metadata or auth challenge, regression of public health exposure.
Risk Score: 92/100 (base 100 – medium deductions).

## Top Risks (Probability × Impact)

1) SEC-001 — 401 challenge missing or malformed
- Prob: Low (1) | Impact: High (3) | Score: 3 (Low)
- Signals: `curl -isk https://mcp.localhost/mcp` returns 200/500 without `WWW-Authenticate` header.
- Mitigations: Automated regression test (`test_unauthenticated_mcp_returns_401_with_prm_hint`) plus evidence capture reduce probability; monitor headers in CI. Reference: docs/architecture/operational-notes-validation-added.md#prm-and-401-ownership, docs/prd/requirements.md#functional-fr.

2) SEC-002 — PRM JSON advertises wrong resource or issuer
- Prob: Low (1) | Impact: High (3) | Score: 3 (Low)
- Signals: `resource` not equal to `MCP_SERVER_URL`; missing Keycloak issuer; clients fail discovery.
- Mitigations: PRM payload built from env values with helper; integration test `test_prm_route_returns_expected_payload` + evidence. Reference: docs/architecture/prm-shape-minimal-example-mvp.md#prm-shape--minimal-example-mvp, docs/validation.md#1-protected-resource-metadata-prm.

3) OPS-001 — Public endpoints inadvertently require auth
- Prob: Low (1) | Impact: Medium (2) | Score: 2 (Low)
- Signals: `/healthz` or PRM route return 401 after auth wiring.
- Mitigations: Keep those routes outside auth provider; add regression curl for `/healthz` over HTTPS. Reference: docs/architecture/observability-health.md#observability--health, docs/stories/1.3.prm-and-401-hint.md#acceptance-criteria.

4) TECH-001 — Env toggles mis-handle absent issuer/audience
- Prob: Low (1) | Impact: Medium (2) | Score: 2 (Low)
- Signals: Local dev without issuer fails to start or still forces auth.
- Mitigations: Guard RemoteAuthProvider initialization behind issuer presence; add tests for both configured and unconfigured modes. Reference: sample-deep-research-mcp/sample_mcp.py, docs/architecture/configuration-environment-variables.md#configuration--environment-variables.

5) SEC-003 — Logging leaks bearer tokens/PRM secrets
- Prob: Low (1) | Impact: High (3) | Score: 3 (Low)
- Signals: App logs `Authorization` header or prints token payloads.
- Mitigations: Follow security controls for redaction; review logging statements during implementation. Reference: docs/architecture/security-controls.md#security-controls.

6) OPS-002 — Evidence missing for Gate A
- Prob: Medium (2) | Impact: Low (1) | Score: 2 (Low)
- Signals: PR merges without PRM/401 curl outputs; gate reviewers lack proof.
- Mitigations: Add checklist in PR template; store outputs under docs/qa/evidence per AC5. Reference: docs/validation.md#1-protected-resource-metadata-prm, docs/validation.md#3-401-with-prm-hint-unauthenticated.

## Controls & Checks
- PRM payload derived from env configuration for parity with `.env.example`.
- RemoteAuthProvider only attaches when issuer present, preserving local dev UX.
- Public routes (`/healthz`, PRM) remain unauthenticated to avoid regressions.
- Evidence capture required in PR (curl outputs attached under docs/qa/evidence).

## Residual Risk
- Remaining exposure is primarily configuration drift (wrong envs in staging) and regression of headers. Residual risk acceptable after implementing mitigations plus regression curls.

## Risk-Based Testing Priorities
1. Verify unauthenticated `/mcp` returns 401 with exact `WWW-Authenticate` header (P0 security smoke).
2. Validate PRM JSON matches env-configured values, including content-type and cache headers.
3. Regression check that `/healthz` stays public (no auth) both before and after issuer is set.
4. Negative case: remove issuer env to ensure PRM/401 gracefully disable without breaking server.
5. Audit logs for absence of sensitive header dumps.
