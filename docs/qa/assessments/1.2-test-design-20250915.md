# QA Test Design — Story 1.2: Traefik Routing + TLS Labels

Date: 2025-09-15
Story: docs/stories/1.2.traefik-routing-and-tls-labels.md
Purpose: Define verifiable tests tied to ACs and risks.

## Scope & Assumptions
- Label‑only Traefik config; no static files.
- Local testing uses `mcp.localhost` and `auth.localhost` hosts entries.
- Only `/healthz` is in scope for S2; PRM/401/JWKS handled in S3–S4.

## Test Approach
- Type: Configuration + integration smoke via Docker Compose and curl.
- Evidence: Paste command outputs or attach logs in PR.

## Test Cases (map to ACs)

TC‑1: Traefik up with HTTPS entrypoint (AC1, AC2)
- Steps:
  1. `docker compose up -d` with reference compose.
  2. `docker compose logs traefik | tail -n +1 | rg -i "entrypoints: websecure|acme|listening"`.
- Expected:
  - Traefik exposes `:443` and ACME resolver configured; no fatal errors.

TC‑2: MCP router resolves host rule and TLS (AC2)
- Steps:
  1. `docker compose exec traefik traefik show routers | rg -A2 "mcp@docker"` (if plugin available) OR check dashboard/logs.
  2. Verify labels applied on MCP container via `docker inspect`.
- Expected:
  - Router `mcp` with `rule=Host(`mcp.localhost`)`, `entrypoints=websecure`, `tls=true`.

TC‑3: Health via HTTPS through Traefik (AC1, AC5)
- Steps:
  1. `curl -isk https://mcp.localhost/healthz` | sed -n '1,10p'
  2. `curl -sS https://mcp.localhost/healthz | jq`.
- Expected:
  - Status `200` with `Content-Type: application/json` and body `{ "ok": true }`.

TC‑4: Backend bind correctness (Risk‑3)
- Steps:
  1. `docker compose exec traefik wget -qO- http://mcp:8000/healthz`.
- Expected:
  - Returns `{ "ok": true }`, confirming LB port and container bind.

TC‑5: Hostname resolution sanity (Risk‑4)
- Steps:
  1. `getent hosts mcp.localhost` (Linux/macOS alternative: `dscacheutil -q host -a name mcp.localhost`).
- Expected:
  - Resolves to 127.0.0.1 for local testing.

TC‑6: No static Traefik files used (AC3, Risk‑6)
- Steps:
  1. Inspect compose and runtime mounts: `docker compose ps && docker inspect traefik`.
- Expected:
  - No static config files mounted beyond ACME storage; routing configured by labels.

Negative/Edge Cases
- N1: Invalid host — `curl -isk https://wrong.localhost/healthz` returns router miss (not 200).
- N2: HTTP scheme — `curl -sS http://mcp.localhost/healthz` either redirects or rejects; only HTTPS accepted per router.

## Data & Environment
- Hosts: add `127.0.0.1 mcp.localhost auth.localhost`.
- Env: no secrets; `BIND_HOST=0.0.0.0`, `BIND_PORT=8000` for MCP.

## Exit Criteria
- TC‑1..6 pass; evidence attached in PR.
- No high‑severity unresolved risks remain for S2 scope.

