# QA Test Design — Story 1.3: PRM and 401 Hint

Date: 2025-09-16
Story: docs/stories/1.3.prm-and-401-hint.md
Purpose: Define verifiable tests for PRM publication and PRM-linked 401 enforcement.

## Scope & Assumptions
- MCP runs inside Docker/compose with Traefik labels from S2; issuer/audience envs configurable via `.env`.
- Keycloak realm available at `https://auth.localhost/realms/mcp` with valid JWKS for positive paths.
- Tests may substitute mock issuer when running locally without full IdP by stubbing JWKS responses.

## Test Approach
- Prioritize integration and security smoke tests that exercise FastMCP server + Traefik proxy.
- Capture curl evidence per Validation Guide to satisfy Gate A.
- Include unit coverage for PRM payload builder to prevent regression when env defaults change.

## Test Cases (mapped to ACs & Risks)

| ID | Level | Priority | Requirement | Mitigates | Description |
| --- | --- | --- | --- | --- | --- |
| 1.3-UNIT-001 | Unit | P1 | AC1 | SEC-002 | Construct PRM payload from env defaults (resource, authorization_servers, headers). |
| 1.3-INT-001 | Integration | P0 | AC1, AC2 | SEC-002, OPS-001 | Spin up FastMCP app (without Traefik) and assert `GET /.well-known/oauth-protected-resource` returns 200, correct JSON + `application/json; charset=utf-8`. |
| 1.3-INT-002 | Integration | P0 | AC3 | SEC-001 | With issuer configured, call `/mcp` unauthenticated → expect 401 + exact `WWW-Authenticate: Bearer resource_metadata="<PRM URL>"`. |
| 1.3-INT-003 | Integration | P1 | AC4 | OPS-001 | Verify `/healthz` returns 200 unauthenticated even when issuer is set. |
| 1.3-INT-004 | Integration | P1 | AC4 | TECH-001 | Start server without issuer env; ensure `/mcp` responds 200 (no auth enforced) and PRM route returns 404/disabled per design or friendly message. Confirm no crash. |
| 1.3-E2E-001 | E2E | P0 | AC2, AC3, AC5 | SEC-001, SEC-002, OPS-002 | Through Traefik, curl PRM + 401 challenge and save outputs under `docs/qa/evidence/1.3-*` for Gate A evidence.

## Additional Scenarios
- Negative: Provide malformed bearer token, ensure response is 401 with same PRM hint (SEC-001).
- Monitoring: Inspect logs to confirm Authorization header redaction (SEC-003).

## Data & Environment
- `.env` includes `MCP_SERVER_URL`, `KC_ISSUER`, `MCP_AUDIENCE`; optional fallback audience for compatibility as documented.
- Hosts entries: `127.0.0.1 mcp.localhost auth.localhost`.
- Mock JWKS server or recorded JWKS JSON for automated tests to avoid external dependency.

## Recommended Execution Order
1. 1.3-UNIT-001 — fail fast on payload mistakes.
2. 1.3-INT-001 & 1.3-INT-002 — core PRM + 401 enforcement.
3. 1.3-INT-003 & 1.3-INT-004 — regression on public routes and no-issuer mode.
4. 1.3-E2E-001 — Traefik smoke & evidence capture (tie to Gate A).

## Coverage Summary
- Scenarios total: 6
- By level: unit 1, integration 4, e2e 1
- By priority: P0 = 3, P1 = 3, P2 = 0, P3 = 0
- Coverage gaps: None (every AC backed by at least one test)

## Gate YAML Snippet
```yaml
test_design:
  scenarios_total: 6
  by_level:
    unit: 1
    integration: 4
    e2e: 1
  by_priority:
    p0: 3
    p1: 3
    p2: 0
    p3: 0
  coverage_gaps: []
```

## Trace Hooks
- Test design matrix: docs/qa/assessments/1.3-test-design-20250916.md
- P0 tests identified: 3

