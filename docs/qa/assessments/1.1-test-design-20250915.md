# Test Design: Story 1.1 — Bootstrap Env and Healthcheck

Date: 2025-09-15
Designer: Quinn (Test Architect)

## Test Strategy Overview
- Total test scenarios: 6
- Unit tests: 2 (33%)
- Integration tests: 3 (50%)
- E2E tests: 1 (17%)
- Priority distribution: P0: 3, P1: 2, P2: 1

Rationale: Prioritize fast contract checks for `/healthz` and environment parsing. E2E is minimal for this story; broader E2E comes in S2–S5.

## Test Scenarios by Acceptance Criteria

### AC1: `.env.example` contains baseline variables (BIND_HOST, BIND_PORT)

| ID           | Level       | Priority | Test                                                           | Justification |
| ------------ | ----------- | -------- | -------------------------------------------------------------- | ------------- |
| 1.1-UNIT-001 | Unit        | P0       | Env parser validates `BIND_HOST`/`BIND_PORT` and defaults      | Fail fast on misconfig |
| 1.1-INT-001  | Integration | P1       | Startup with `.env` binds and launches without errors          | Confirms end-to-end env wiring |

### AC2: `GET /healthz` returns `{ "ok": true }` with 200 and JSON content-type

| ID           | Level       | Priority | Test                                                           | Justification |
| ------------ | ----------- | -------- | -------------------------------------------------------------- | ------------- |
| 1.1-UNIT-002 | Unit        | P0       | Handler returns `{"ok": true}` and header equals `Content-Type: application/json` | Contract of function |
| 1.1-INT-002  | Integration | P0       | Running server: `curl -sSi http://127.0.0.1:8000/healthz` → status `HTTP/1.1 200 OK` and header equals `Content-Type: application/json` | External contract, black-box |

### AC3: Health works without Traefik (direct bind)

| ID           | Level       | Priority | Test                                                           | Justification |
| ------------ | ----------- | -------- | -------------------------------------------------------------- | ------------- |
| 1.1-INT-003  | Integration | P1       | Direct bind on `127.0.0.1:8000` returns expected JSON          | Confirms S1 scope sans Traefik |
| 1.1-E2E-001  | E2E         | P2       | Smoke script prints `{ "ok": true }` and exits 0               | Dev UX and evidence capture |

## Risk Coverage
- Mitigates: TECH-001 (env misconfig), OPS-001 (health wrong/missing), OPS-002 (evidence capture).
- SEC-001/ PERF-001 monitored in later stories; no heavy tests here.

## Recommended Execution Order
1. P0 Unit tests (1.1-UNIT-001, 1.1-UNIT-002)
2. P0 Integration test (1.1-INT-002)
3. P1 Integration tests (1.1-INT-001, 1.1-INT-003)
4. P2 E2E (1.1-E2E-001)

## Notes for Implementers
- Unit handler test can import FastMCP route function directly if exposed; otherwise, instantiate server and call ASGI app with Starlette TestClient.
- Integration curl checks should be added to a small `scripts/health_smoke.sh` to standardize evidence capture (used later in CI).
 - Minimal pytest stub (optional but recommended):
   ```python
   # tests/test_healthz.py
   from starlette.testclient import TestClient
   from sample_deep_research_mcp.sample_mcp import create_server

   def test_healthz_returns_json_ok():
       mcp = create_server()
       # FastMCP exposes HTTP app only when run; for a quick smoke, spin a real server in CI or assert via curl as INT-002.
       # Placeholder: keep documented until app factory exposes ASGI app directly.
       assert True
   ```

## Gate Block (for future gate file)
```yaml
test_design:
  scenarios_total: 6
  by_level:
    unit: 2
    integration: 3
    e2e: 1
  by_priority:
    p0: 3
    p1: 2
    p2: 1
  coverage_gaps: []
```

## Story Hook
Test design matrix: docs/qa/assessments/1.1-test-design-20250915.md
