# Story 1.3: PRM and 401 Hint

Status: Ready for Review

## Story
**As a** developer/operator,
**I want** the MCP to publish OAuth Protected Resource Metadata and return a PRM-linked 401 for unauthenticated requests,
**so that** OAuth clients can discover the authorization server and authenticate before calling MCP tools.

Dependencies: Story 1.2 (Traefik routing + TLS labels) — Done

## Acceptance Criteria
1. `GET https://mcp.localhost/.well-known/oauth-protected-resource` returns HTTP 200 with JSON containing `resource == MCP_SERVER_URL` and `authorization_servers` listing the configured Keycloak issuer, served with `Content-Type: application/json; charset=utf-8`. [Source: docs/prd/requirements.md#functional-fr] [Source: docs/architecture/prm-shape-minimal-example-mvp.md#prm-shape--minimal-example-mvp] [Source: docs/validation.md#1-protected-resource-metadata-prm]
2. The PRM endpoint remains publicly reachable through Traefik over HTTPS without authentication, using the existing router/labels for `mcp.localhost`. [Source: docs/architecture/reference-deployment-docker-traefik-proposed.md#compose-with-traefik-labels] [Source: docs/validation.md#1-protected-resource-metadata-prm]
3. Unauthenticated requests to protected MCP endpoints (e.g., `https://mcp.localhost/mcp`) return HTTP 401 with header `WWW-Authenticate: Bearer resource_metadata="https://mcp.localhost/.well-known/oauth-protected-resource"`. [Source: docs/prd/requirements.md#functional-fr] [Source: docs/architecture/operational-notes-validation-added.md#prm-and-401-ownership] [Source: docs/validation.md#3-401-with-prm-hint-unauthenticated]
4. Public routes such as `GET /healthz` stay unauthenticated with 200 responses, while 401 enforcement activates only when issuer/audience env vars are configured. [Source: docs/architecture/observability-health.md#observability--health] [Source: docs/architecture/configuration-environment-variables.md#configuration--environment-variables]
5. Capture and attach validation evidence (curl outputs for PRM JSON and 401 header) per the Validation Guide in the story PR/commit. [Source: docs/validation.md#1-protected-resource-metadata-prm] [Source: docs/validation.md#3-401-with-prm-hint-unauthenticated]

## Tasks / Subtasks
- [x] Implement PRM endpoint (AC: 1, 2)
  - [x] Add a `/.well-known/oauth-protected-resource` route in `sample_deep-research-mcp/sample_mcp.py` returning the architecture-defined JSON and cache headers. [Source: docs/architecture/prm-shape-minimal-example-mvp.md#prm-shape--minimal-example-mvp]
  - [x] Source env-driven values for `resource` and authorization servers using existing configuration helpers to keep container and local runs aligned. [Source: docs/architecture/configuration-environment-variables.md#configuration--environment-variables]
  - [x] Confirm route is registered within FastMCP so Traefik can proxy it without additional compose changes. [Source: docs/architecture/source-tree-and-module-organization.md#key-modules-and-their-purpose]
- [x] Enforce PRM-linked 401 for protected endpoints (AC: 3, 4)
  - [x] Configure `RemoteAuthProvider`/JWT verifier to require Bearer tokens when issuer envs are present and publish PRM metadata via the provider. [Source: docs/architecture/frnfr-gates-evidence-map.md#frnfr--gates--evidence-map]
  - [x] Ensure `/healthz` and the PRM route remain publicly accessible while `/mcp` returns the specified 401 challenge when unauthenticated. [Source: docs/architecture/observability-health.md#observability--health] [Source: docs/architecture/operational-notes-validation-added.md#prm-and-401-ownership]
  - [x] Validate that removing issuer envs restores unauthenticated access for local dev scenarios. [Source: docs/architecture/configuration-environment-variables.md#configuration--environment-variables]
- [x] Documentation, evidence, and environment updates (AC: 1, 5)
  - [x] Capture curl outputs for PRM JSON and 401 header, store under docs/qa/evidence (or link in PR) per Validation Guide. [Source: docs/validation.md#1-protected-resource-metadata-prm] [Source: docs/validation.md#3-401-with-prm-hint-unauthenticated]
  - [x] Confirm `.env.example` already documents the required issuer/audience variables and update if gaps remain. [Source: docs/architecture/configuration-environment-variables.md#configuration--environment-variables]
  - [x] Note validation steps in story/PR description referencing Gate A evidence expectations. [Source: docs/architecture/frnfr-gates-evidence-map.md#frnfr--gates--evidence-map]
- [x] Testing & automation (AC: 3, 5)
  - [x] Add or update automated tests or scripts that exercise unauthenticated `/mcp` (expect 401 + header) and PRM route success. [Source: docs/architecture/testing-reality.md#testing-reality]
  - [x] Integrate validation steps into existing CI or document manual runs until automated coverage exists. [Source: docs/architecture/operational-notes-validation-added.md#prm-and-401-ownership]

## Dev Notes
- Previous Story Insights
  - Traefik already routes `https://mcp.localhost` to the MCP container with TLS via labels, so the PRM endpoint will be reachable without additional proxy changes. [Source: docs/architecture/reference-deployment-docker-traefik-proposed.md#compose-with-traefik-labels]
- Data Models / Payloads
  - PRM payload is static JSON with `resource` set to the external MCP URL and `authorization_servers` listing the Keycloak realm URL. [Source: docs/architecture/prm-shape-minimal-example-mvp.md#prm-shape--minimal-example-mvp]
- API Specifications
  - Protected MCP endpoints (e.g., `/mcp`, `/mcp/messages/`) must reject unauthenticated requests with a Bearer challenge referencing the PRM URL. [Source: docs/architecture/operational-notes-validation-added.md#prm-and-401-ownership]
- File Locations
  - `sample-deep-research-mcp/sample_mcp.py` hosts the FastMCP server, auth wiring, and custom routes for health/PRM. [Source: docs/architecture/source-tree-and-module-organization.md#key-modules-and-their-purpose]
- Testing Requirements
  - MVP relies on curl-based validation of PRM JSON and 401 responses; no automated suite exists yet, so scripts or manual runs must be documented. [Source: docs/architecture/testing-reality.md#testing-reality]
- Technical Constraints & Config
  - Use env vars (`MCP_SERVER_URL`, `KC_ISSUER`, `MCP_AUDIENCE`, optional `MCP_ALT_AUDIENCE`) to drive PRM content and auth behavior; avoid logging secrets. [Source: docs/architecture/configuration-environment-variables.md#configuration--environment-variables]
  - Bearer tokens must be supplied via `Authorization` header only; emit structured audit logs for auth decisions. [Source: docs/architecture/security-controls.md#security-controls]

### References (exact shards)
- PRD — Requirements FR1–FR2: docs/prd/requirements.md#functional-fr
- PRD — Epic 1 Summary: docs/prd/epic-list.md
- Architecture — PRM Shape: docs/architecture/prm-shape-minimal-example-mvp.md#prm-shape--minimal-example-mvp
- Architecture — Traefik Reference: docs/architecture/reference-deployment-docker-traefik-proposed.md#compose-with-traefik-labels
- Architecture — Env Vars: docs/architecture/configuration-environment-variables.md#configuration--environment-variables
- Architecture — PRM/401 Operations: docs/architecture/operational-notes-validation-added.md#prm-and-401-ownership
- Architecture — Source Tree: docs/architecture/source-tree-and-module-organization.md#key-modules-and-their-purpose
- Architecture — Testing Reality: docs/architecture/testing-reality.md#testing-reality
- Architecture — Security Controls: docs/architecture/security-controls.md#security-controls
- Validation Guide — PRM & 401 Evidence: docs/validation.md#1-protected-resource-metadata-prm, docs/validation.md#3-401-with-prm-hint-unauthenticated

## Testing
- Approach: Use curl-based smoke checks (PRM JSON, unauthorized `/mcp`) until automated coverage lands. [Source: docs/validation.md#1-protected-resource-metadata-prm]
- Scenarios
  - `curl -sS https://mcp.localhost/.well-known/oauth-protected-resource | jq` returns the configured JSON shape. [Source: docs/validation.md#1-protected-resource-metadata-prm]
  - `curl -isk https://mcp.localhost/mcp | sed -n '1,15p'` shows HTTP 401 with `WWW-Authenticate` header referencing the PRM URL. [Source: docs/validation.md#3-401-with-prm-hint-unauthenticated]
  - Health check `curl -sS https://mcp.localhost/healthz | jq` remains `{ "ok": true }` with 200. [Source: docs/validation.md#4-health-check]

## QA Results

### Review Date: 2025-09-16
### Reviewed By: Quinn (Test Architect)

#### Code Quality Assessment
- `CupcakeRemoteAuthProvider` cleanly extends RemoteAuthProvider and scopes PRM metadata to `MCP_SERVER_URL`; no refactor required.
- Evidence automation via TestClient captured curl-equivalent artifacts; no outstanding defects observed.

#### Test Coverage
- Verified new integration tests (`tests/test_prm_and_401.py`) cover PRM payload, 401 challenge, health public access, and issuer toggle fallback.
- `tests/test_healthz.py` updated to reuse shared helper; pytest suite passes locally.
- Traceability matrix: docs/qa/assessments/1.3-trace-20250916.md (all ACs fully covered).

#### NFR Assessment
- Security/performance/reliability/maintainability all PASS (docs/qa/assessments/1.3-nfr-20250916.md); residual risk primarily configuration drift.

#### Recommendations
- Consider adding live JWKS smoke in S4 and automating curl evidence in CI for ongoing assurance.

Gate Recommendation: PASS (Gate file docs/qa/gates/1.3-prm-and-401-hint.yml)

## Change Log

| Date       | Version | Description                     | Author |
| ---------- | ------- | ------------------------------- | ------ |
| 2025-09-16 | 0.1     | Initial draft of Story 1.3      | SM     |
| 2025-09-16 | 1.0     | Implemented PRM + 401 enforcement | Dev    |


## Dev Agent Record
### Agent Model Used
Codex CLI — dev agent

### Debug Log References
- `.venv/bin/pytest`
- docs/qa/evidence/1.3-prm-status.txt
- docs/qa/evidence/1.3-prm-headers.txt
- docs/qa/evidence/1.3-prm-body.json
- docs/qa/evidence/1.3-401-status.txt
- docs/qa/evidence/1.3-401-headers.txt
- docs/qa/evidence/1.3-health-status.txt
- docs/qa/evidence/1.3-health-body.json

### Completion Notes List
- Added `CupcakeRemoteAuthProvider` so PRM metadata uses `MCP_SERVER_URL`, returns cache-control 60s, and still guards `/mcp` with `WWW-Authenticate` hints.
- Verified health endpoint stays public and issuer toggles disable auth; ensured unauthorized `/mcp` yields 401 with PRM link.
- Implemented integration tests and shared utilities covering PRM payload, 401 header, and no-issuer fallback; updated existing health test to reuse helper.
- Captured evidence artifacts for PRM JSON, 401 response, and health output under `docs/qa/evidence/` for Gate A traceability.

### File List
docs/stories/1.3.prm-and-401-hint.md
sample-deep-research-mcp/sample_mcp.py
tests/__init__.py
tests/_utils.py
tests/test_healthz.py
tests/test_prm_and_401.py
docs/qa/evidence/1.3-prm-status.txt
docs/qa/evidence/1.3-prm-headers.txt
docs/qa/evidence/1.3-prm-body.json
docs/qa/evidence/1.3-401-status.txt
docs/qa/evidence/1.3-401-headers.txt
docs/qa/evidence/1.3-health-status.txt
docs/qa/evidence/1.3-health-body.json
