# Story 1.2: Traefik Routing + TLS Labels

Status: Review

## Story
**As a** developer/operator,
**I want** Traefik to route the MCP service over HTTPS using labels,
**so that** the sample MCP is reachable at its public hostname with TLS termination and no static Traefik files.

Dependencies: Story 1.1 (health endpoint and env template) — Done

## Acceptance Criteria
1. Compose defines a `traefik` reverse proxy exposing `:80` and `:443` and enabling TLS via a certificates resolver. The MCP service is labeled so that `https://mcp.localhost/healthz` returns HTTP 200 with JSON `{ "ok": true }` through Traefik. [Source: docs/architecture/reference-deployment-docker-traefik-proposed.md]
2. TLS is enabled on the MCP router with `entrypoints=websecure` and an ACME resolver configured in Traefik; HTTPS requests to `mcp.localhost` succeed (local testing may use a self‑signed certificate; pass `-k` to curl if needed). [Source: docs/architecture/reference-deployment-docker-traefik-proposed.md]
3. No static Traefik config files are required; routing is label‑driven only. [Source: docs/prd/ingress-routing-traefik.md]
4. Baseline environment variables for MCP (`BIND_HOST`, `BIND_PORT`) remain compatible and the app binds so Traefik can reach it (container `0.0.0.0:8000`). [Source: docs/architecture/configuration-environment-variables.md]
5. Evidence is captured per Validation Guide: `curl -sS https://mcp.localhost/healthz | jq` shows `{ "ok": true }` and HTTP 200. Evidence is attached in PR/commit. [Source: docs/validation.md#4-health-check]

Notes:
- Optional RFC 8414 path‑insert shims for Keycloak live in S6 and are not required to pass S2, but labels may be staged if desired. [Source: docs/architecture/reference-deployment-docker-traefik-proposed.md]

## Tasks / Subtasks
- [x] Add Traefik to compose
  - [x] Define `traefik` service with Docker provider and entrypoints `web` (:80) and `websecure` (:443). [Source: docs/architecture/reference-deployment-docker-traefik-proposed.md]
  - [x] Configure ACME resolver for local testing (e.g., `tlschallenge`, storage volume). [Source: docs/architecture/reference-deployment-docker-traefik-proposed.md]
- [x] Label the MCP service for routing
  - [x] Set `traefik.enable=true` on MCP container. [Source: docs/architecture/reference-deployment-docker-traefik-proposed.md]
  - [x] Add router rule `Host(\`mcp.localhost\`)`, `entrypoints=websecure`, and `tls=true`. [Source: docs/architecture/reference-deployment-docker-traefik-proposed.md]
  - [x] Set service load balancer port to `8000`. Ensure app binds `0.0.0.0:8000`. [Source: docs/architecture/configuration-environment-variables.md]
- [ ] Validate HTTPS health through Traefik
  - [ ] `docker compose up -d`; confirm Traefik and MCP are healthy. [Source: docs/validation.md]
  - [x] `curl -sS -k --resolve mcp.localhost:18443:127.0.0.1 https://mcp.localhost:18443/healthz | jq` → `{ "ok": true }` and HTTP 200 (using alt local port due to conflicts). Evidence saved. [Source: docs/validation.md#4-health-check]
  - [ ] Ensure local hosts resolution: add `127.0.0.1 mcp.localhost auth.localhost` to `/etc/hosts` (for local testing) or configure DNS accordingly. [Source: docs/validation.md]
- [ ] Update docs
  - [ ] Reference the Validation Guide section for health via Traefik. [Source: docs/validation.md]
  - [ ] Note that RFC 8414 shim is deferred to S6. [Source: docs/prd/epic-list.md]

## Dev Notes
- Compose and Traefik
  - Use the reference `compose.yaml` structure: Traefik with Docker provider; MCP service with labels. [Source: docs/architecture/reference-deployment-docker-traefik-proposed.md]
  - Example labels on MCP:
    - `traefik.http.routers.mcp.rule=Host(\`mcp.localhost\`)`
    - `traefik.http.routers.mcp.entrypoints=websecure`
    - `traefik.http.routers.mcp.tls=true`
    - `traefik.http.services.mcp.loadbalancer.server.port=8000`
  - Traefik mounts the Docker socket read‑only and a volume for ACME storage. [Source: docs/architecture/reference-deployment-docker-traefik-proposed.md]
- Environment variables
  - App variables remain per config: `BIND_HOST=0.0.0.0`, `BIND_PORT=8000`. Traefik routes to the container port. [Source: docs/architecture/configuration-environment-variables.md]
  - External URLs (e.g., `MCP_SERVER_URL`) will be exercised in later stories; not required to satisfy S2. [Source: docs/prd/requirements.md]
- Health endpoint
  - Story 1.1 ensured `/healthz` exists; S2 confirms it works via HTTPS routed through Traefik. [Source: docs/architecture/observability-health.md]
- Optional (deferred to S6)
  - RFC 8414 path‑insert shim on `auth.localhost` via `ReplacePathRegex` if Keycloak is added in the compose. Not required to pass S2. [Source: docs/architecture/reference-deployment-docker-traefik-proposed.md]

### References (exact shards)
- PRD — Epic 1 Stories (S2 summary): docs/prd/epic-list.md
- PRD — Ingress & Routing (Traefik): docs/prd/ingress-routing-traefik.md
- Architecture — Reference Deployment (Docker + Traefik): docs/architecture/reference-deployment-docker-traefik-proposed.md
- Architecture — Env Vars: docs/architecture/configuration-environment-variables.md
- Architecture — Observability & Health: docs/architecture/observability-health.md
- Validation — Health Check via Traefik: docs/validation.md#4-health-check

## Testing
- Approach: smoke test via `curl` through Traefik to `/healthz` over HTTPS; optional container health checks.
- Scenarios
  - `https://mcp.localhost/healthz` returns `{ "ok": true }` and HTTP 200.
  - Traefik router shows TLS on `websecure`; no static file configuration used.
  - If using a self‑signed local cert, use `curl -k` for test runs.

## QA Results
- Trace: docs/qa/assessments/1.2-trace-20250915.md
- NFR Assessment: docs/qa/assessments/1.2-nfr-20250915.md
- Risk Profile: docs/qa/assessments/1.2-risk-profile-20250915.md
- Test Design: docs/qa/assessments/1.2-test-design-20250915.md
- PO Validation: docs/qa/assessments/1.2-po-validation-20250915.md
- QA Review: docs/qa/assessments/1.2-review-20250915.md
- QA Gate: docs/qa/gates/1.2-traefik-routing-and-tls-labels.yml (Decision: PASS — evidence captured via alt port 18443)

## Change Log

| Date       | Version | Description                    | Author |
| ---------- | ------- | ------------------------------ | ------ |
| 2025-09-15 | 0.1     | Initial draft of Story 1.2     | SM     |


## Dev Agent Record
### Agent Model Used
Codex CLI — dev agent
### Debug Log References
- Evidence files:
  - docs/qa/evidence/1.2-healthz-https-status.txt
  - docs/qa/evidence/1.2-healthz-https-body.json
  - docs/qa/evidence/1.2-healthz-https-headers.txt
  - docs/qa/evidence/1.2-docker-ps.txt
  - docs/qa/evidence/1.2-traefik-mounts.json
### Completion Notes List
- Added Traefik service and ACME config in `compose.yaml`; exposed web/websecure with Docker provider. Host ports configured via `.env` to avoid conflicts.
- Labeled MCP service with router rule, entrypoints `websecure`, TLS enabled, and LB port 8000.
- Confirmed app binds on `0.0.0.0:8000` in container.
- Optional Keycloak service and discovery shim labels present (not required for S2 acceptance).
- Per fastmcp 2.5.x, set `TRANSPORT=sse` for server start; guarded auth imports for S3+.
- Captured HTTPS health evidence via Traefik using host override and alt port (18443); see Evidence files.
### File List
docs/stories/1.2.traefik-routing-and-tls-labels.md
compose.yaml
.env.example
.env
sample-deep-research-mcp/Dockerfile
sample-deep-research-mcp/requirements.txt
sample-deep-research-mcp/sample_mcp.py
