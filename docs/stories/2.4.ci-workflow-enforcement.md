# Story 2.4: CI Workflow Enforcement

Status: Draft

## Story

**As a** maintainer responsible for release quality,
**I want** a GitHub Actions workflow that runs the lint, format, type check, and coverage suite on every push and PR,
**so that** regressions are blocked automatically and evidence is captured for reviewers.

Dependencies: Stories 2.1–2.3 complete (baseline tooling, type checks, tests).

## Acceptance Criteria

1. `.github/workflows/ci.yml` exists and runs on push + pull request events for the repository.
2. Workflow steps include: `uv sync` (with caching), `uvx ruff check --output-format github`, `uvx ruff format --check`, `uv run ty check`, and `uv run pytest --cov --cov-report=xml --cov-report=term`.
3. Workflow caches `~/.cache/uv` (or appropriate directories) to reduce runtime; cache key considers `uv.lock` or `pyproject` hashes.
4. Coverage XML artifact (`coverage.xml`) and HTML report tarball (`coverage-html.tar.gz`) uploaded for each workflow run.
5. Intentional failure scenario documented: a branch with a formatting error demonstrates workflow failing and link to run is captured in issue/PR comment.

Evidence: link to successful workflow run (screenshot optional) and failure demonstration run referenced in Issue #5 or PR thread.

## Tasks / Subtasks

- [ ] Author workflow
  - [ ] Create `.github/workflows/ci.yml` with job matrix (Linux runner) and steps detailed above.
  - [ ] Configure environment variables (e.g., `UV_CACHE_DIR`) if necessary.
- [ ] Add caching
  - [ ] Use `actions/cache` for `.cache/uv` keyed by OS + hash of `uv.lock` or `pyproject.toml`.
- [ ] Artifact handling
  - [ ] After tests, archive coverage HTML folder and upload along with `coverage.xml`.
  - [ ] Optionally upload junit XML if available.
- [ ] Failure demo
  - [ ] Create temporary branch/commit with formatting violation to confirm workflow fails; capture run URL.
  - [ ] Document outcome in Issue #5 or PR comment.
- [ ] Documentation hooks
  - [ ] Update story or issue with instructions for re-running workflow via `gh workflow run` (optional).

## Dev Notes

- Consider using `uv tool run` vs `uvx`; ensure runner has Python 3.11+.
- Set `RUST_BACKTRACE=1` for Ruff step to aid debugging if needed.
- Evaluate whether to split jobs (lint/test) for parallelism; keep initial implementation single job for simplicity.

### References

- Story Seed S4: docs/stories/SEED-epic-2-testing-foundations.md#s4--ci-workflow-enforcement
- GitHub Actions guidance: https://github.blog/changelog/2025-05-22-enhanced-python-ci-setup-with-uv-and-ruff/
- Issue #5: https://github.com/DrJLabs/mcp-farm/issues/5

## Testing

- Trigger workflow via `workflow_dispatch` or PR; ensure all steps succeed.
- For failure test, intentionally break formatting and confirm job fails at Ruff step.

## QA Results

- Risk Assessment: docs/qa/assessments/2.4-risk-20250916.md (Quinn — 2025-09-16)
- Test Design: docs/qa/assessments/2.4-test-design-20250916.md (Quinn — 2025-09-16)
- PO Validation: Pending — complete after workflow implementation review.

## Change Log

| Date       | Version | Description                | Author |
| ---------- | ------- | -------------------------- | ------ |
| 2025-09-16 | 0.1     | Initial draft of Story 2.4 | SM     |
