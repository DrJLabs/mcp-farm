# Story 2.3: Expand Unit & Integration Coverage

Status: Draft

## Story

**As a** quality-focused developer,
**I want** targeted tests for the sample MCP tools and streaming path,
**so that** critical behaviors are guarded by automated coverage and we can enforce the ≥80% threshold before enabling CI gates.

Dependencies: Stories 2.1 and 2.2 (baseline config + type-check alignment).

## Acceptance Criteria

1. New pytest unit tests cover `search` and `fetch` functions in `sample-deep-research-mcp/sample_mcp.py`, including error cases (unknown ID raises `ValueError`).
2. Auth edge-case tests validate server behavior when auth is enabled/disabled (reuse fixtures in `tests/_utils.py`); ensure coverage of JWKS/audience fallback code paths.
3. Streaming smoke is executed via pytest (e.g., `tests/integration/test_stream_smoke.py`) invoking `scripts/stream_smoke.py` or equivalent logic; test marked with `@pytest.mark.integration`.
4. `pytest-cov` is configured (e.g., via `pyproject.toml` or `pytest.ini`) to enforce ≥80% line coverage and emit `coverage.xml` and HTML report under `tests/coverage/`.
5. Running `uv run pytest --cov` produces ≥80% coverage and the reports are listed in PR artifacts; `pytest --markers` shows the new `integration` marker description.

Evidence: attach coverage summary and marker list to PR or issue comment; upload coverage artifacts in CI once Story 2.4 lands.

## Tasks / Subtasks

- [ ] Unit tests for tool functions
  - [ ] Add pytest module for `search` covering positive/negative queries.
  - [ ] Add pytest module for `fetch` covering valid ID and failure case.
- [ ] Auth edge-case coverage
  - [ ] Extend existing tests or add new ones to assert JWT fallback flows and `resource_documentation` behavior if set.
- [ ] Streaming smoke integration
  - [ ] Wrap `scripts/stream_smoke.py` logic in pytest test; ensure optional auth token handling.
  - [ ] Tag test with `pytest.mark.integration` and update `pytest.ini` marker description.
- [ ] Coverage configuration
  - [ ] Update `pytest.ini` or `pyproject.toml` to include `addopts = --cov=sample-deep-research-mcp --cov=fastmcp --cov-report=xml --cov-report=html:tests/coverage/html --cov-report=term` (adjust as needed).
  - [ ] Ensure reports go to a deterministic path (`tests/coverage/`). Add `.gitignore` entry if required.
- [ ] Validation commands
  - [ ] Run `uv run pytest --cov` locally; capture summary.
  - [ ] Run `pytest --markers` to confirm integration marker docstring.

## Dev Notes

- Use fixtures in `tests/_utils.py` to reuse server factory; consider adding helpers for sample data lookup.
- For streaming smoke, prefer using `httpx.AsyncClient` or subprocess invocation with timeouts to avoid hanging CI.
- Aim for deterministic tests (no network calls beyond local app).
- Coverage threshold can be set via `--cov-fail-under=80`.

### References

- Story Seed S3: docs/stories/SEED-epic-2-testing-foundations.md#s3--unit-and-integration-coverage-expansion
- Validation guide: docs/validation.md (stream smoke requirements)
- Issue #5: https://github.com/DrJLabs/mcp-farm/issues/5

## Testing

- Command: `uv run pytest --cov --cov-fail-under=80`.
- Inspect generated `coverage.xml` and HTML reports for completeness.

## QA Results

- Risk Assessment: docs/qa/assessments/2.3-risk-20250916.md (Quinn — 2025-09-16)
- Test Design: docs/qa/assessments/2.3-test-design-20250916.md (Quinn — 2025-09-16)
- PO Validation: Pending — capture once acceptance review occurs.

## Change Log

| Date       | Version | Description                | Author |
| ---------- | ------- | -------------------------- | ------ |
| 2025-09-16 | 0.1     | Initial draft of Story 2.3 | SM     |
