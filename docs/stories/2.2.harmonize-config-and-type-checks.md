# Story 2.2: Harmonize Package Configs & Type Checks

Status: Ready for Review

## Story

**As a** maintainer of the MCP Farm mono-repo,
**I want** a single source of truth for Ruff and type-check settings,
**so that** package-level configuration stays aligned with the repo-wide tooling baseline and static analysis covers shared code.

Dependencies: Story 2.1 (repo-level Ruff/Prettier baseline) must be complete.

## Acceptance Criteria

1. `fastmcp/pyproject.toml` references the root Ruff configuration (no duplicate rule definitions); any residual per-package ignores are documented inline with rationale.
2. `tool.ty.src.include` (or equivalent config) covers `sample-deep-research-mcp/` and `tests/`; `tool.ty.rules` ignores are reviewed, with remaining suppressions documented in issue #5.
3. `uv run ty check` passes using the updated configuration.
4. `uvx ruff settings --show-settings` (or `ruff settings`) confirms matching include/exclude scopes for `[tool.ruff]`, `[tool.ruff.lint]`, and `[tool.ruff.format]` when executed from repo root and `fastmcp/` subdirectory.
5. A summary comment is posted in GitHub issue #5 listing any lingering type-check ignore codes and planned follow-up tickets (if needed).
6. Issue #5 notes that Ty is under active development and documents a fallback to Ruff-only or mypy if regressions surface.

Evidence: attach `uv run ty check` output and `ruff settings` diff in PR description or link to issue comment.

## Tasks / Subtasks

- [x] Consolidate Ruff configuration
  - [x] Remove or simplify `tool.ruff` blocks inside `fastmcp/pyproject.toml` to inherit root settings.
  - [x] Add inline comments for any per-module ignore overrides that must remain.
  - [x] Ensure `[tool.ruff.format]`/`[tool.ruff.lint]` share the same `exclude`/`extend-exclude` paths set at the repo root.
- [x] Expand type-check coverage
  - [x] Update `tool.ty.src.include`/`exclude` to cover shared modules and tests.
  - [x] Review `tool.ty.rules` ignores; document rationale in Issue #5 and create follow-up tasks for high-count suppressions.
  - [x] Decide whether `respect-ignore-files` should remain enabled; document the decision in Issue #5.
- [x] Validation commands
  - [x] Run `uv run ty check` at repo root; capture output.
  - [x] Run `uvx ruff settings` from repo root and `fastmcp/` to confirm identical scope.
- [x] Communication
  - [x] Post summary comment in Issue #5 with results and remaining action items.

## Dev Notes

- `ty` supports configuration in `pyproject.toml`; ensure includes use forward slashes and relative paths.
- Consider adding a helper script (e.g., `scripts/typecheck.sh`) to standardize command for CI story.
- If ty cannot cover non-package directories, use stub modules or adjust `src` mapping accordingly.
- Ty is still shipping as a preview; plan for breakage by retaining quick toggles for Ruff-only or mypy runs if upstream changes land mid-sprint.

### Rationale — 2025-09-16

- Ruff's 2025 configuration docs highlight aligning `[tool.ruff]`, `[tool.ruff.lint]`, and `[tool.ruff.format]` include/exclude scopes, hence the added verification step and task to avoid diverging settings between root and package configs.citeturn4search0
- Ty's reference guide documents explicit `include`/`exclude` arrays and the optional `respect-ignore-files` toggle, so the story now calls out those decisions and records the tool's preview status in Issue #5.citeturn4search1turn1search4

### References

- Story Seed S2: docs/stories/SEED-epic-2-testing-foundations.md#s2--harmonize-package-configs--type-checks
- Testing/tooling plan: docs/issues/testing-tooling-baseline.md (Plan §2 section)
- GitHub Issue #5: https://github.com/DrJLabs/mcp-farm/issues/5

## Testing

- Commands: `uv run ty check`, `uvx ruff settings` (root + subdirectory).
- Optional: create pytest-based smoke that loads ty config using `tomllib` and asserts include paths.

## QA Results

- Risk Assessment: docs/qa/assessments/2.2-risk-20250916.md (Quinn — 2025-09-16)
- Test Design: docs/qa/assessments/2.2-test-design-20250916.md (Quinn — 2025-09-16)
- Requirements Trace: docs/qa/assessments/2.2-trace-20250917.md (Quinn — 2025-09-17)
- NFR Assessment: docs/qa/assessments/2.2-nfr-20250917.md (Quinn — 2025-09-17)
- PO Validation: docs/qa/assessments/2.2-po-validation-20250917.md (Sarah — 2025-09-17)

## Change Log

| Date       | Version | Description                                      | Author |
| ---------- | ------- | ------------------------------------------------ | ------ |
| 2025-09-16 | 0.2     | Analyst refresh: Ruff/Ty config alignment notes  | Analyst |
| 2025-09-16 | 0.1     | Initial draft of Story 2.2                       | SM     |

## Dev Agent Record

### Agent Model Used

Codex CLI — dev agent

### Debug Log References

- `cd fastmcp && uv run ty check`
- `uvx ruff check --show-settings`
- `cd fastmcp && uvx ruff check --show-settings`

### Completion Notes List

- Promoted Ty configuration to the repo root `pyproject.toml`, covering `fastmcp/src`, `fastmcp/tests`, `sample-deep-research-mcp`, and `tests/` while keeping `respect-ignore-files = true`.
- Updated `fastmcp/pyproject.toml` to extend the root Ruff baseline, documented per-file ignores, and pinned `target-version = "py311"` so linting from the package tree matches repo scope.
- Refactored `tests/_utils.py` to call `create_streamable_http_app` with explicit keyword arguments, resolving the new Ty coverage on cross-package tests.
- Captured validation evidence (`cd fastmcp && uv run ty check`, `uvx ruff check --show-settings`) and logged remaining Ty suppressions/fallback plan in Issue #5 (Ty runs under the package dir because `uv` requires a `[project]` table).

### File List

pyproject.toml
fastmcp/pyproject.toml
sample-deep-research-mcp/sample_mcp.py
tests/_utils.py
docs/stories/2.2.harmonize-config-and-type-checks.md
